#!/usr/bin/env python3
#
# Copyright (c) 2014 Sebastian Noack
#
# This program is free software; you can redistribute it and/or modify it
# under the terms of the GNU General Public License as published by the
# Free Software Foundation; either version 3 of the License, or (at your
# option) any later version.
#
# This program is distributed in the hope that it will be useful, but
# WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY
# or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
# for more details.

import os
import sys
import random
import string
import argparse
from getpass import getpass

from mypass import Error
from mypass.client import Client

def generate_password():
	chars = [
		random.choice(string.ascii_lowercase),
		random.choice(string.ascii_uppercase),
		random.choice(string.digits),
		random.choice(string.punctuation),
	]

	while len(chars) < 16:
		chars.append(chr(random.randint(33, 126)))

	random.shuffle(chars)
	return ''.join(chars)

def prompt_new_passphrase():
	password = getpass('New passphrase: ')

	if password != getpass('Verify passphrase: '):
		print("Password doesn't match!", file=sys.stderr)
		sys.exit(1)

	return password

class CLI:
	def __init__(self):
		try:
			self._parse_arguments()
			os.umask(0o077)

			with Client() as self._client:
				self._open_database()
				getattr(self, '_call_' + self._args.command)()
		except Error as e:
			print(e, file=sys.stderr)
			sys.exit(1)
		except KeyboardInterrupt:
			print(file=sys.stderr)
			sys.exit(1)

	def _parse_arguments(self):
		parser = argparse.ArgumentParser()

		subparsers = parser.add_subparsers(dest='command')
		subparsers.required = True

		subparser_get = subparsers.add_parser('get', help='Writes the requested password to stdout')
		subparser_get.add_argument('nickname')
		subparser_get.set_defaults(exit_if_db_does_not_exist=True)

		subparser_add = subparsers.add_parser('add', help='Adds the given password to the database')
		subparser_add.add_argument('nickname')
		subparser_add.add_argument('password', nargs='?')

		subparser_new = subparsers.add_parser('new', help='Generates a new password and adds it to the database')
		subparser_new.add_argument('nickname')

		subparser_remove = subparsers.add_parser('remove', help='Removes a password from the database')
		subparser_remove.add_argument('nickname')
		subparser_remove.set_defaults(fail_if_db_does_not_exist=True)

		subparser_list = subparsers.add_parser('list', help='Writes the nicknames of all passwords to stdout')
		subparser_list.set_defaults(exit_if_db_does_not_exist=True)

		subparser_changepw = subparsers.add_parser('changepw', help='Changes the master passphrase')
		subparser_changepw.set_defaults(fail_if_db_does_not_exist=True)

		subparser_lock = subparsers.add_parser('lock', help='Closes the database and forgets the master passhrase')
		subparser_lock.set_defaults(exit_if_disconnected=True)

		self._args = parser.parse_args()

	def _open_database(self):
		if self._client.status != Client.CONNECTED and getattr(self._args, 'exit_if_disconnected', False):
			sys.exit(0)

		if self._client.status == Client.DATABASE_DOES_NOT_EXIST:
			if getattr(self._args, 'fail_if_db_does_not_exist', False):
				print('Database does not exist', file=sys.stderr)
				sys.exit(1)

			if getattr(self._args, 'exit_if_db_does_not_exist', False):
				sys.exit(0)

			self._client.create_database(prompt_new_passphrase())

		if self._client.status == Client.DATABASE_LOCKED:
			self._client.unlock_database(getpass('Unlock database: '))

	def _call_get(self):
		print(self._client.call('get', self._args.nickname))

	def _call_add(self, password=None):
		nickname = self._args.nickname
		password = password or self._args.password or getpass()

		try:
			self._client.call('add', nickname, password)
		except NicknameAlreadyExists:
			if input('Nickname already exists. Do you want to override it? [y/N] ')[:1].lower() != 'y':
				print('Aborted', file=sys.stderr)
				sys.exit(1)

			self._client.call('add', nickname, password, True)

	def _call_new(self):
		password = generate_password()
		self._call_add(password)
		print(password)

	def _call_remove(self):
		self._client.call('remove', self._args.nickname)

	def _call_list(self):
		for nickname in self._client.call('list'):
			print(nickname)

	def _call_changepw(self):
		self._client.call('changepw', prompt_new_passphrase())

	def _call_lock(self):
		self._client.call('shutdown')

if __name__ == '__main__':
	CLI()
